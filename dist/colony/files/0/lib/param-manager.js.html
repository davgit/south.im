<h1>param-manager.js</h1>
<pre><code class="lang-js"><span class="keyword">const</span> TWEAKABLE = require(<span class="string">'../config.json'</span>).tweakable
<span class="keyword">var</span> clone = require(<span class="string">'clone'</span>)

module.exports = ParamManager

<span class="function"><span class="keyword">function</span> <span class="title">ParamManager</span><span class="params">(shell)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> ParamManager)) <span class="keyword">return</span> <span class="keyword">new</span> ParamManager(shell)
  <span class="keyword">this</span>.shell = shell
  <span class="keyword">this</span>.keys = []
  <span class="keyword">this</span>.prev = {}
  <span class="keyword">this</span>.goal = {}
  <span class="keyword">this</span>.curr = Object.create(<span class="literal">null</span>)

  <span class="keyword">this</span>.curr[<span class="string">'lut mix'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: <span class="number">0</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'lut 1'</span>] = {
      type: <span class="string">'choice'</span>
    , left: <span class="literal">true</span>
    , value: <span class="string">'normal'</span>
    , choices: Object.keys(require(<span class="string">'../dist/luts.json'</span>))
  }
  <span class="keyword">this</span>.curr[<span class="string">'lut 2'</span>] = {
      type: <span class="string">'choice'</span>
    , value: <span class="string">'normal'</span>
    , choices: Object.keys(require(<span class="string">'../dist/luts.json'</span>))
  }

  <span class="keyword">this</span>.curr[<span class="string">'mosaic amount'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: <span class="number">0</span>, max: <span class="number">100</span>, left: <span class="literal">true</span> }
  <span class="keyword">this</span>.curr[<span class="string">'rgb shift'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: <span class="number">0</span>, max: <span class="number">5</span>, left: <span class="literal">true</span> }
  <span class="keyword">this</span>.curr[<span class="string">'haze amount'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: <span class="number">0</span>, max: <span class="number">2</span>, left: <span class="literal">true</span> }

  <span class="keyword">this</span>.curr[<span class="string">'camera spin'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: -Math.PI, max: Math.PI, left: <span class="literal">true</span> }
  <span class="keyword">this</span>.curr[<span class="string">'camera angle'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0</span>, min: -<span class="number">3</span>, max: <span class="number">3</span>, left: <span class="literal">true</span>  }
  <span class="keyword">this</span>.curr[<span class="string">'camera distance'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0.75</span>, min: <span class="number">0.1</span>, max: <span class="number">5</span>, left: <span class="literal">true</span>  }
  <span class="keyword">this</span>.curr[<span class="string">'fov'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">0.25</span>, min: <span class="number">0</span>, max: <span class="number">1</span>, left: <span class="literal">true</span>  }
  <span class="keyword">this</span>.curr[<span class="string">'vignette'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([-<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>, <span class="number">1.001</span>]), min: -<span class="number">1.5</span>, max: <span class="number">1.5</span>, left: <span class="literal">true</span> }

  <span class="keyword">this</span>.curr[<span class="string">'shark height'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">2</span>, min: -<span class="number">2</span>, max: <span class="number">2</span> }
  <span class="keyword">this</span>.curr[<span class="string">'water level'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">12.125</span>, min: <span class="number">11</span>, max: <span class="number">15</span> }
  <span class="keyword">this</span>.curr[<span class="string">'water color'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">0.52</span>, <span class="number">1.06</span>, <span class="number">1.46</span>]), min: <span class="number">0</span>, max: <span class="number">2</span> }
  <span class="keyword">this</span>.curr[<span class="string">'egg brightness'</span>] = { type: <span class="string">'number'</span>, value: <span class="number">1</span>, min: <span class="number">0</span>, max: <span class="number">3</span> }
  <span class="keyword">this</span>.curr[<span class="string">'egg color'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">1</span>, <span class="number">0.7</span>, <span class="number">0.4</span>]), min: <span class="number">0</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'sky color'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]), min: <span class="number">0</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'directional color 1'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]), min: <span class="number">0</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'directional color 2'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]), min: <span class="number">0</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'directional dir 1'</span>] = { noColor: <span class="literal">true</span>, type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]), min: -<span class="number">1</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'directional dir 2'</span>] = { noColor: <span class="literal">true</span>, type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]), min: -<span class="number">1</span>, max: <span class="number">1</span> }
  <span class="keyword">this</span>.curr[<span class="string">'tree main color'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]), min: <span class="number">0</span>, max: <span class="number">1</span>, left: <span class="literal">true</span> }
  <span class="keyword">this</span>.curr[<span class="string">'tree stump color'</span>] = { type: <span class="string">'array'</span>, value: <span class="keyword">new</span> Float32Array([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]), min: <span class="number">0</span>, max: <span class="number">1</span>, left: <span class="literal">true</span> }

  <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> <span class="keyword">this</span>.curr) {
    <span class="keyword">this</span>.keys.push(k)
    <span class="keyword">this</span>.prev[k] = copy(<span class="keyword">this</span>.curr[k])
    <span class="keyword">this</span>.goal[k] = copy(<span class="keyword">this</span>.curr[k])
  }

  <span class="keyword">this</span>.curr = preprocess(<span class="keyword">this</span>.curr)
  <span class="keyword">this</span>.duration = <span class="number">1000</span>
  <span class="keyword">this</span>.ticker = <span class="number">0</span>
}

ParamManager.prototype.tween = <span class="keyword">function</span>(t) {
  <span class="keyword">var</span> keys = <span class="keyword">this</span>.keys
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i += <span class="number">1</span>) {
    <span class="keyword">var</span> k = keys[i]
    <span class="keyword">this</span>.curr[k].value = <span class="keyword">this</span>.tweener[
      <span class="keyword">this</span>.curr[k].type
    ](<span class="keyword">this</span>.curr[k].value
    , <span class="keyword">this</span>.prev[k]
    , <span class="keyword">this</span>.goal[k], t)
  }
}

ParamManager.prototype.tweener = {}
ParamManager.prototype.tweener.number = <span class="keyword">function</span>(_, a, b, t) {
  <span class="keyword">return</span> a + (b - a) * t
}
ParamManager.prototype.tweener.array = <span class="keyword">function</span>(out, a, b, t) {
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; out.length; i += <span class="number">1</span>)
    out[i] = a[i] + (b[i] - a[i]) * t
  <span class="keyword">return</span> out
}

<span class="function"><span class="keyword">function</span> <span class="title">preprocess</span><span class="params">(obj)</span> {</span>
  Object.keys(obj).forEach(<span class="keyword">function</span>(key) {
    <span class="keyword">return</span> obj[key] = wrap(obj[key])
  })

  <span class="keyword">return</span> obj
}

<span class="function"><span class="keyword">function</span> <span class="title">wrap</span><span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; <span class="string">'length'</span> <span class="keyword">in</span> value) {
    <span class="keyword">return</span> value = { type: <span class="string">'array'</span>, value: value }
  }
  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span>) {
    <span class="keyword">return</span> value
  }
  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'number'</span>) {
    <span class="keyword">return</span> value = { type: <span class="string">'number'</span>, value: value }
  }
}

<span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">(value)</span> {</span>
  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Float32Array) <span class="keyword">return</span> <span class="keyword">new</span> Float32Array(value)
  <span class="keyword">return</span> clone(value)
}
</code></pre>